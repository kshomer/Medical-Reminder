
```
User: /add
Bot: "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞:"
User: "–í–∏—Ç–∞–º–∏–Ω D3"
Bot: [–ö–Ω–æ–ø–∫–∏: –°–µ–≥–æ–¥–Ω—è | –ó–∞–≤—Ç—Ä–∞]
User: –ù–∞–∂–∏–º–∞–µ—Ç "–°–µ–≥–æ–¥–Ω—è"
Bot: [–ö–Ω–æ–ø–∫–∏: –ë–µ—Å—Å—Ä–æ—á–Ω–æ | 7 –¥–Ω–µ–π | 14 –¥–Ω–µ–π | 30 –¥–Ω–µ–π]
User: –ù–∞–∂–∏–º–∞–µ—Ç "–ë–µ—Å—Å—Ä–æ—á–Ω–æ"
Bot: [–ö–Ω–æ–ø–∫–∏: –ö–∞–∂–¥—ã–π –¥–µ–Ω—å | –ü–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ | –ß–µ—Ä–µ–∑ N –¥–Ω–µ–π]
User: –ù–∞–∂–∏–º–∞–µ—Ç "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å"
Bot: "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è (–ß–ß:–ú–ú):"
User: "09:00"
Bot: "–í–≤–µ–¥–∏—Ç–µ –¥–æ–∑–∏—Ä–æ–≤–∫—É:"
User: "1 –∫–∞–ø—Å—É–ª–∞"
Bot: "–û—Å–æ–±—ã–µ —É–∫–∞–∑–∞–Ω–∏—è?" [–ö–Ω–æ–ø–∫–∏: –î–æ –µ–¥—ã | –ü–æ—Å–ª–µ –µ–¥—ã | –ù–µ–∑–∞–≤–∏—Å–∏–º–æ]
User: "–ù–µ–∑–∞–≤–∏—Å–∏–º–æ"
Bot: "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ: ..." [‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å | ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å | ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
User: ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
Bot: "‚úÖ –õ–µ–∫–∞—Ä—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!"

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### US-2: –ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫ –∫—É—Ä—Å–æ–º

```
User: /add ‚Üí "–ê–º–æ–∫—Å–∏—Ü–∏–ª–ª–∏–Ω"
User: –í—ã–±–∏—Ä–∞–µ—Ç: –°–µ–≥–æ–¥–Ω—è ‚Üí 7 –¥–Ω–µ–π ‚Üí –ö–∞–∂–¥—ã–π –¥–µ–Ω—å
User: –í—Ä–µ–º—è 1: "08:00" ‚Üí –î–æ–∑–∏—Ä–æ–≤–∫–∞: "500 –º–≥"
Bot: "–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –≤—Ä–µ–º—è?" [–î–∞ | –ù–µ—Ç]
User: –î–∞
User: –í—Ä–µ–º—è 2: "14:00" ‚Üí –î–æ–∑–∏—Ä–æ–≤–∫–∞: "500 –º–≥"
User: –î–∞
User: –í—Ä–µ–º—è 3: "20:00" ‚Üí –î–æ–∑–∏—Ä–æ–≤–∫–∞: "500 –º–≥"
User: –ù–µ—Ç ‚Üí –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: "–ü–æ—Å–ª–µ –µ–¥—ã"
User: ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å

–†–µ–∑—É–ª—å—Ç–∞—Ç: 3 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –¥–µ–Ω—å, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
```

### US-3: –ü—Ä–æ–ø—É—Å–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```
09:00 - Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É]
10:00 - –°–∏—Å—Ç–µ–º–∞ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ MISSED
10:01 - Bot: "‚ö†Ô∏è –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤–∞"

–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é:
User: /stats
Bot: 
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π
üíä –í–∏—Ç–∞–º–∏–Ω D3: 6/7 (85.7%)
üíä –ê–º–æ–∫—Å–∏—Ü–∏–ª–ª–∏–Ω: 19/21 (90.5%)
–û–±—â–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å: 89.3% üéØ
```

---

## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// utils/format.utils.ts

export function formatMedicationList(medications: Medication[]): string {
  if (medications.length === 0) {
    return 'üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /add —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.';
  }
  
  let message = 'üíä *–í–∞—à–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞:*\n\n';
  
  medications.forEach((med, index) => {
    message += `${index + 1}. *${med.name}*\n`;
    message += `   üìÖ ${formatDateRange(med.startDate, med.endDate)}\n`;
    message += `   üïê ${formatSchedules(med.schedules)}\n`;
    if (med.notes) {
      message += `   üìù ${med.notes}\n`;
    }
    message += '\n';
  });
  
  return message;
}

export function formatDateRange(start: Date, end: Date | null): string {
  const startStr = format(start, 'dd.MM.yyyy');
  
  if (!end) {
    return `—Å ${startStr} (–±–µ—Å—Å—Ä–æ—á–Ω–æ)`;
  }
  
  const endStr = format(end, 'dd.MM.yyyy');
  return `${startStr} - ${endStr}`;
}

export function formatSchedules(schedules: Schedule[]): string {
  return schedules.map(s => `${s.time} (${s.dosage})`).join(', ');
}

export function formatStats(stats: ComplianceStats): string {
  const { totalScheduled, totalTaken, totalMissed, totalSkipped } = stats;
  const rate = ((totalTaken / (totalScheduled - totalSkipped)) * 100).toFixed(1);
  
  return (
    `üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ ${stats.periodDays} –¥–Ω–µ–π*\n\n` +
    `‚úÖ –ü—Ä–∏–Ω—è—Ç–æ: ${totalTaken} –∏–∑ ${totalScheduled}\n` +
    `‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${totalMissed}\n` +
    `‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø—Ä–µ–¥–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ: ${totalSkipped}\n\n` +
    `*–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å —Å–æ–±–ª—é–¥–µ–Ω–∏—è: ${rate}%* ${getComplianceEmoji(parseFloat(rate))}`
  );
}

function getComplianceEmoji(rate: number): string {
  if (rate >= 95) return 'üèÜ';
  if (rate >= 85) return 'üéØ';
  if (rate >= 70) return 'üëç';
  if (rate >= 50) return '‚ö†Ô∏è';
  return '‚ùå';
}
```

---

## –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (i18n)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤

```typescript
// locales/ru.json
{
  "commands": {
    "start": {
      "welcome": "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Med Reminder Bot!",
      "already_registered": "‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!"
    },
    "add": {
      "enter_name": "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞:",
      "enter_time": "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú:",
      "success": "‚úÖ –õ–µ–∫–∞—Ä—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!"
    },
    "list": {
      "empty": "üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–µ–∫–∞—Ä—Å—Ç–≤.",
      "header": "üíä –í–∞—à–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞:"
    }
  },
  "notifications": {
    "reminder": "üíä –í—Ä–µ–º—è –ø—Ä–∏–Ω—è—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ!\n\nüìã {{name}}\nüíâ –î–æ–∑–∏—Ä–æ–≤–∫–∞: {{dosage}}",
    "taken": "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –ü—Ä–∏—ë–º –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.",
    "missed": "‚ö†Ô∏è –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤–∞."
  },
  "buttons": {
    "taken": "‚úÖ –ü—Ä–∏–Ω—è–ª",
    "snooze": "‚è∞ +15 –º–∏–Ω",
    "skip": "‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å",
    "save": "‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
    "cancel": "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```typescript
import i18n from '../utils/i18n';

bot.command('start', async (ctx) => {
  const user = ctx.state.user;
  const lang = user?.language || 'ru';
  
  await ctx.reply(
    i18n.t('commands.start.welcome', { lng: lang })
  );
});
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞

### Unit —Ç–µ—Å—Ç—ã –∫–æ–º–∞–Ω–¥

```typescript
// bot/commands/start.test.ts
describe('Start Command', () => {
  let bot: Telegraf;
  let mockUserService: jest.Mocked<UserService>;
  
  beforeEach(() => {
    mockUserService = {
      getUserByTelegramId: jest.fn(),
      createUser: jest.fn()
    } as any;
    
    bot = createTestBot({ userService: mockUserService });
  });
  
  it('should register new user', async () => {
    mockUserService.getUserByTelegramId.mockResolvedValue(null);
    mockUserService.createUser.mockResolvedValue({ id: 1 } as any);
    
    const message = createMockMessage('/start', { id: 123 });
    await bot.handleUpdate({ message } as any);
    
    expect(mockUserService.createUser).toHaveBeenCalledWith(
      123,
      expect.objectContaining({ firstName: expect.any(String) })
    );
  });
  
  it('should not register existing user', async () => {
    mockUserService.getUserByTelegramId.mockResolvedValue({ id: 1 } as any);
    
    const message = createMockMessage('/start', { id: 123 });
    await bot.handleUpdate({ message } as any);
    
    expect(mockUserService.createUser).not.toHaveBeenCalled();
  });
});
```

### Integration —Ç–µ—Å—Ç—ã FSM

```typescript
// bot/scenes/addMedication.test.ts
describe('Add Medication Scene', () => {
  it('should complete full flow', async () => {
    const bot = createTestBot();
    const userId = 123;
    
    // –®–∞–≥ 1: –í—Ö–æ–¥ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π
    await bot.sendCommand('/add', userId);
    expect(bot.lastMessage).toContain('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
    
    // –®–∞–≥ 2: –ù–∞–∑–≤–∞–Ω–∏–µ
    await bot.sendMessage('–ê—Å–ø–∏—Ä–∏–Ω', userId);
    expect(bot.lastMessage).toContain('–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ');
    
    // –®–∞–≥ 3: –ü—Ä–æ–ø—É—Å–∫ –æ–ø–∏—Å–∞–Ω–∏—è
    await bot.sendMessage('/skip', userId);
    expect(bot.lastMessage).toContain('–ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç–µ');
    
    // –®–∞–≥ 4: –í—ã–±–æ—Ä –¥–∞—Ç—ã
    await bot.clickButton('start_today', userId);
    expect(bot.lastMessage).toContain('–ö–∞–∫ –¥–æ–ª–≥–æ');
    
    // ... –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
    
    // –§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await bot.clickButton('confirm_save', userId);
    expect(bot.lastMessage).toContain('—É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
    const medications = await prisma.medication.findMany({
      where: { userId }
    });
    expect(medications).toHaveLength(1);
    expect(medications[0].name).toBe('–ê—Å–ø–∏—Ä–∏–Ω');
  });
});
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫

```typescript
// utils/errors.ts

export class BotError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500
  ) {
    super(message);
    this.name = 'BotError';
  }
}

export class ValidationError extends BotError {
  constructor(message: string) {
    super(message, 'VALIDATION_ERROR', 400);
  }
}

export class NotFoundError extends BotError {
  constructor(resource: string) {
    super(`${resource} not found`, 'NOT_FOUND', 404);
  }
}

export class RateLimitError extends BotError {
  constructor() {
    super('Too many requests', 'RATE_LIMIT', 429);
  }
}
```

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫

```typescript
bot.catch(async (err, ctx) => {
  logger.error({
    error: err,
    userId: ctx.from?.id,
    update: ctx.update
  }, 'Bot error');
  
  if (err instanceof ValidationError) {
    return ctx.reply(`‚ùå ${err.message}`);
  }
  
  if (err instanceof NotFoundError) {
    return ctx.reply('‚ùå –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
  }
  
  if (err instanceof RateLimitError) {
    return ctx.reply('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.');
  }
  
  // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
  await ctx.reply(
    '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.\n\n' +
    'ID –æ—à–∏–±–∫–∏: ' + generateErrorId()
  );
  
  // –£–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–æ–≤
  if (process.env.ADMIN_CHAT_ID) {
    await bot.telegram.sendMessage(
      process.env.ADMIN_CHAT_ID,
      `‚ö†Ô∏è –û—à–∏–±–∫–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from?.id}\n\n${err.message}`
    );
  }
});
```

---

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ answerCbQuery

```typescript
// ‚ùå –ü–ª–æ—Ö–æ
bot.action('some_action', async (ctx) => {
  // –ó–∞–±—ã–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback
  await ctx.reply('Done');
});

// ‚úÖ –•–æ—Ä–æ—à–æ
bot.action('some_action', async (ctx) => {
  await ctx.reply('Done');
  await ctx.answerCbQuery(); // –£–±–∏—Ä–∞–µ—Ç "—á–∞—Å–∏–∫–∏" –∑–∞–≥—Ä—É–∑–∫–∏
});
```

### 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /cancel

```typescript
bot.command('cancel', async (ctx) => {
  if (ctx.scene) {
    await ctx.scene.leave();
    await ctx.reply('‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.');
  } else {
    await ctx.reply('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.');
  }
});
```

### 3. –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥

```typescript
// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
if (!timeRegex.test(userInput)) {
  return ctx.reply('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ß–ß:–ú–ú (09:00)');
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã
const date = parse(userInput, 'dd.MM.yyyy', new Date());
if (!isValid(date)) {
  return ctx.reply('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (15.10.2025)');
}
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞

```typescript
// –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
await ctx.reply('–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:', {
  reply_markup: {
    inline_keyboard: [
      [{ text: 'üá∑üá∫ –†—É—Å—Å–∫–∏–π', callback_data: 'lang_ru' }],
      [{ text: 'üá¨üáß English', callback_data: 'lang_en' }],
      [{ text: 'üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞', callback_data: 'lang_uk' }]
    ]
  }
});
```

### 5. –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

```typescript
bot.command('add', async (ctx) => {
  logger.info({ userId: ctx.from.id }, 'User started adding medication');
  await ctx.scene.enter('add-medication');
});

bot.action(/taken_(\d+)/, async (ctx) => {
  logger.info({ 
    userId: ctx.from.id, 
    logId: ctx.match[1] 
  }, 'User confirmed medication intake');
  
  // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
});
```

---

## Webhook vs Polling

### Polling (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

```typescript
// index.ts
if (process.env.NODE_ENV === 'development') {
  bot.launch({
    dropPendingUpdates: true
  });
  
  logger.info('Bot started in polling mode');
}
```

### Webhook (–¥–ª—è production)

```typescript
// server.ts
import Fastify from 'fastify';

const app = Fastify();

app.post('/webhook/telegram', async (req, reply) => {
  const secret = req.headers['x-telegram-bot-api-secret-token'];
  
  if (secret !== process.env.WEBHOOK_SECRET) {
    return reply.status(403).send('Forbidden');
  }
  
  await bot.handleUpdate(req.body);
  return reply.status(200).send('OK');
});

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
await bot.telegram.setWebhook(
  `${process.env.TELEGRAM_WEBHOOK_DOMAIN}/webhook/telegram`,
  {
    secret_token: process.env.WEBHOOK_SECRET
  }
);

app.listen({ port: 3000, host: '0.0.0.0' });
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ë–æ—Ç Med Reminder –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Telegram –±–æ—Ç–æ–≤:
- ‚úÖ FSM –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ Middleware –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –ª–æ–≥–∏–∫–∏
- ‚úÖ Callback handlers –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–π UX –∏ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 2.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 15 –æ–∫—Ç—è–±—Ä—è 2025
